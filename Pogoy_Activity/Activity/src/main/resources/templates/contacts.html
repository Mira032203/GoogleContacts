<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Google Contacts</title>
</head>
<body>
<h1>Your Contacts</h1>
<ul>
    <li th:each="contact : ${contacts}">
        <span th:text="${contact.displayName}"></span>
        <span th:text="${contact.email}"></span>

        <!-- Update Contact Form -->
        <form onsubmit="convertToPatch(event, this)">
            <input type="hidden" name="resourceName" th:value="${contact.resourceName}">
            <input type="text" name="newName" th:value="${contact.displayName}" required>
            <input type="email" name="newEmail" th:value="${contact.email}" required>
            <button type="submit">Update</button>
        </form>

        <!-- Delete Contact Form -->
        <form action="/contacts/delete" method="post">
            <input type="hidden" name="resourceName" th:value="${contact.resourceName}">
            <button type="submit">Delete</button>
        </form>
    </li>
</ul>

<!-- Add Contact Form -->
<form id="addContactForm" action="/contacts/add" method="post">
    <input type="text" name="name" placeholder="Name" required>
    <input type="email" name="email" placeholder="Email" required>
    <button type="submit">Add Contact</button>
</form>

<script>
    function convertToPatch(event, form) {
    event.preventDefault();
    const formData = new FormData(form);
    let resourceName = formData.get("resourceName");

    console.log("Updating contact with resourceName:", resourceName);
    console.log("Final PATCH URL:", `/contacts/update/${resourceName}`);

    const body = JSON.stringify({
        newName: formData.get("newName"),
        newEmail: formData.get("newEmail")
    });

fetch(`/contacts/update/${resourceName}`, {  // ðŸ”¥ Use `/contacts/update/`
        method: "PATCH",
        body: body,
        headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error("Server Response:", text);
                throw new Error("Failed to update contact: " + text);
            });
        }
        return response.text().then(text => text ? JSON.parse(text) : {}); // âœ… Handle empty responses
    })
    .then(data => {
        console.log("âœ… Contact updated:", data);
        alert("Contact updated successfully!");
        location.reload();
    })
    .catch(error => {
        alert("Failed to update contact. Check console for details.");
        console.error("Error updating contact:", error);
    });
}
</script>


</body>
</html>
